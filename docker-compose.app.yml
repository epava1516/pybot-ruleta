services:
  bot:
    image: ghcr.io/epava1516/pybot-ruleta:latest
    container_name: roulette_bot_telegram
    env_file: .env
    expose:
      - "8080"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1:${WEB_PORT:-8080}/health || exit 1"]
      interval: 20s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  proxy:
    image: nginx:1.25-alpine
    container_name: nginx-proxy
    depends_on:
      bot:
        condition: service_started
    environment:
      DOMAIN: ${DOMAIN}
      WEBHOOK_SECRET: ${WEBHOOK_SECRET}
      NGINX_ENVSUBST_OUTPUT_DIR: ${NGINX_ENVSUBST_OUTPUT_DIR:-/etc/nginx/conf.d}
    volumes:
      - ./nginx/templates:/etc/nginx/templates:ro
      - ./certbot/www:/var/www/certbot:ro
      - ./certbot/conf:/etc/letsencrypt:ro
    ports:
      - "80:80"
      - "443:443"
    restart: unless-stopped

  certbot:
    image: certbot/certbot:latest
    container_name: certbot
    environment:
      DOMAIN: ${DOMAIN}
      EMAIL: ${EMAIL}
    volumes:
      - ./certbot/www:/var/www/certbot
      - ./certbot/conf:/etc/letsencrypt
    entrypoint: ["sh", "-lc"]
    command: |
      set -e
      echo "[certbot] RenovaciÃ³n cada 12h (webroot)"
      while true; do
        certbot renew --webroot -w /var/www/certbot || true
        sleep 12h
      done
    restart: unless-stopped

  reloader:
    image: alpine:3.20
    container_name: nginx-reloader
    environment:
      PROXY_CONTAINER: nginx-proxy
    volumes:
      - ./certbot/conf:/etc/letsencrypt:ro
      - /var/run/docker.sock:/var/run/docker.sock
    entrypoint: ["/bin/sh","-lc"]
    command: |
      set -e
      apk add --no-cache inotify-tools docker-cli
      mkdir -p /etc/letsencrypt/live
      echo "[reloader] watching /etc/letsencrypt/live ..."
      # bucle infinito; aunque inotify falle, reintenta
      while true; do
        inotifywait -r -e close_write,create,delete,move /etc/letsencrypt/live >/dev/null 2>&1 || true
        echo "[reloader] change detected -> nginx reload"
        docker kill -s HUP "$PROXY_CONTAINER" || docker exec "$PROXY_CONTAINER" nginx -s reload || true
        sleep 1
      done
    restart: unless-stopped

