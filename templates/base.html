<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <!-- viewport-fit=cover para usar el área segura en iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>{% block title %}Ruleta — Mini App{% endblock %}</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    {% block head %}{% endblock %}
  </head>
  <body>
    {% block body %}{% endblock %}

    {% block scripts %}
      <script>
        // Pasa chat_id de servidor a front cuando vienes con ?chat_id=
        window.__CHAT_ID__ = "{{ chat_id|default('', true) }}";
      </script>

      <!-- Verificación HMAC: deja cookie tg_ok si vienes embebido en Telegram -->
      <script>
        (function(){
          const tg = window.Telegram && window.Telegram.WebApp;
          if (!tg) return; // navegador normal → el guard del backend decide
          try { tg.ready(); } catch(_) {}
          const initData = tg.initData || "";
          if (!initData) return;
          fetch("/api/session/verify", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ initData })
          }).catch(()=>{});
        })();
      </script>

      <!-- Forzado de FULLSCREEN (Bot API >= 8.0) con fallback al primer toque -->
      <script>
        (function(){
          const tg = window.Telegram && window.Telegram.WebApp;
          if (!tg) return;

          // Expande a altura máxima disponible (útil incluso fuera de fullscreen)
          try { tg.expand(); } catch(_) {}

          // Traza útil para diagnosticar
          try {
            tg.onEvent && tg.onEvent('fullscreenChanged', (isFs) => {
              console.log('[TMA] fullscreenChanged:', isFs);
            });
            tg.onEvent && tg.onEvent('fullscreenFailed', (err) => {
              console.warn('[TMA] fullscreenFailed:', err);
            });
          } catch(_) {}

          async function goFullscreen(){
            if (!tg.requestFullscreen) return; // cliente antiguo / no soportado
            try {
              // En algunos clientes hay que llamar tras interacción del usuario;
              // esto simplemente intentará y si falla lo repetimos en el primer tap.
              await tg.requestFullscreen();
            } catch (e) {
              // Silenciamos: repetiremos en primer gesto
              console.debug('[TMA] requestFullscreen() threw, will retry on first click', e);
            }
          }

          // 1) Intento inmediato (en Android recientes suele valer)
          goFullscreen();

          // 2) Reintento en el primer gesto del usuario (requisito iOS típico)
          window.addEventListener('click', function once(){
            goFullscreen();
            window.removeEventListener('click', once);
          }, { passive:true, once:true });

          // Opcional: si usas gestos verticales en la UI, evita cierre por swipe
          try { tg.disableVerticalSwipes && tg.disableVerticalSwipes(); } catch(_) {}
        })();
      </script>

      <!-- Tu bundle modular -->
      <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
    {% endblock %}
  </body>
</html>

